import numpy as np
import matplotlib.pyplot as plt

# =============================
# WAKE RAKE COORDINATES
# =============================
y_total_mm = np.array([
    0,12,21,27,33,39,45,51,57,63,69,72,75,78,81,84,87,90,93,96,
    99,102,105,108,111,114,117,120,123,126,129,132,135,138,141,
    144,147,150,156,162,168,174,180,186,195,207,219
], dtype=float)

y_static_mm = np.array([
    43.5, 55.5, 67.5, 79.5, 91.5, 103.5,
    115.5, 127.5, 139.5, 151.5, 163.5, 175.5
], dtype=float)

# =============================
# INTERPOLATION FUNCTION
# =============================
def interp_with_linear_extrap(x_new, x, y):
    y_new = np.interp(x_new, x, y)

    if np.any(x_new < x[0]):
        slope = (y[1] - y[0]) / (x[1] - x[0])
        y_new[x_new < x[0]] = y[0] + slope * (x_new[x_new < x[0]] - x[0])

    if np.any(x_new > x[-1]):
        slope = (y[-1] - y[-2]) / (x[-1] - x[-2])
        y_new[x_new > x[-1]] = y[-1] + slope * (x_new[x_new > x[-1]] - x[-1])

    return y_new

# =============================
# WAKE DATA — ALL AoA
# =============================

wake_data = {
    -1.2: {
        "single": {
            "Pt": np.array([
    186.30, 185.17, 187.75, 188.51, 186.33, 186.45, 188.06,
    186.07, 186.85, 187.42, 186.76, 186.27, 187.22, 187.24, 186.64,
    187.89, 186.76, 187.96, 186.22, 183.21, 176.35, 167.05, 160.56,
    164.82, 166.50, 176.34, 181.76, 183.16, 185.11, 187.20, 186.21,
    186.42, 186.97, 185.23, 186.66, 185.73, 186.57, 186.48, 186.70,
    186.62, 187.22, 186.29, 186.38, 186.84, 186.14, 186.76, 187.43
]),
            "Ps": np.array([
    9.82, 10.22, 10.76, 10.51, 9.93, 10.81,
    8.78, 10.61, 11.03, 10.50, 10.35, 9.55
]),
            "rho": 1.194
        }
    },
    0.0: {
        "single": {
            "Pt": np.array([
    185.38, 184.23, 186.88, 187.58, 185.52, 185.56, 187.14, 184.97,
    185.90, 186.44, 185.75, 185.24, 186.41, 186.32, 185.76, 186.80,
    185.47, 185.81, 181.66, 175.73, 167.32, 160.36, 158.81, 167.09,
    170.02, 178.79, 182.83, 183.38, 184.39, 186.32, 185.20, 185.24,
    185.94, 185.91, 185.99, 184.73, 185.64, 185.55, 185.74, 185.70,
    186.37, 185.47, 185.51, 185.88, 185.08, 186.00, 186.61
]),
            "Ps": np.array([
    9.28, 10.40, 10.93, 10.62, 9.86, 10.70,
    8.61, 10.43, 10.66, 10.04, 9.90, 9.87
]),
            "rho": 1.194
        }
    },
    6.0: {
        "single": {
            "Pt": np.array([
    187.83, 187.01, 189.71, 190.27, 188.14, 187.77, 189.74, 187.77,
    188.61, 189.30, 188.60, 188.20, 189.66, 188.96, 188.24, 189.55,
    189.10, 189.84, 187.35, 176.98, 161.12, 154.48, 159.08, 173.50,
    180.31, 188.01, 188.46, 186.72, 187.28, 189.77, 187.84, 188.14,
    188.60, 188.10, 188.28, 187.66, 188.22, 188.19, 188.90, 188.37,
    188.80, 188.05, 188.16, 188.63, 188.66, 188.51, 189.17
]),
            "Ps": np.array([
    8.38, 12.45, 12.77, 11.99, 11.16, 11.53,
    11.43, 10.72, 10.37, 9.45, 9.20, 12.37
]),
            "rho": 1.192
        }
    },
    10.0: {
        "single": {
            "Pt": np.array([
    187.50, 186.65, 189.17, 189.86, 187.78, 187.53, 189.32, 187.32,
    188.27, 188.95, 188.17, 187.67, 189.38, 188.72, 187.81, 189.20,
    188.60, 189.45, 188.40, 187.41, 182.86, 172.40, 153.89, 142.16,
    138.18, 153.38, 170.07, 180.56, 185.65, 189.33, 187.30, 187.82,
    188.02, 187.13, 188.05, 187.15, 187.71, 187.59, 188.77, 187.81,
    188.26, 187.68, 187.73, 188.00, 188.05, 188.09, 188.83
]),
            "Ps": np.array([
    7.84, 13.16, 13.50, 12.56, 11.59, 10.39,
    11.05, 10.75, 10.33, 9.11, 8.89, 13.27
]),
            "rho": 1.192
        }
    },
    13.5: {
        "pre": {
            "Pt": np.array([
    184.62, 183.35, 185.98, 186.98, 184.65, 184.78, 186.30, 184.26,
    185.19, 185.62, 185.08, 184.54, 186.11, 185.45, 184.73, 185.49,
    183.30, 178.69, 168.26, 153.04, 136.69, 124.36, 117.74, 121.02,
    126.51, 144.25, 159.75, 170.80, 178.27, 185.05, 184.10, 184.49,
    185.27, 184.40, 185.27, 184.36, 185.19, 185.21, 186.08, 185.41,
    185.33, 184.88, 185.14, 185.47, 185.32, 185.53, 186.15
]),
            "Ps": np.array([
    8.82, 13.76, 14.32, 13.52, 10.83, 5.46,
    6.68, 5.66, 8.72, 10.14, 10.08, 13.65
]),
            "rho": 1.191
        },
        "post": {
            "Pt": np.array([
    187.77, 186.90, 189.52, 190.08, 188.00, 188.11, 189.62, 187.60,
    188.59, 189.00, 185.34, 180.21, 173.00, 161.83, 148.11, 136.72,
    129.64, 127.71, 131.91, 141.08, 154.26, 166.25, 174.38, 183.01,
    184.05, 188.25, 188.14, 186.42, 187.02, 189.53, 187.70, 188.02,
    188.23, 186.61, 187.99, 187.26, 187.89, 187.85, 188.93, 188.04,
    188.33, 187.61, 187.85, 188.08, 188.12, 188.13, 188.95
]),
            "Ps": np.array([
    6.25, 12.63, 12.35, 8.04, 4.81, 7.42, 5.25,
    9.24, 9.49, 8.07, 7.49, 12.65
]),
            "rho": 1.190
        }
    },
    14.5: {
        "pre": {
            "Pt": np.array([
    188.88, 188.03, 190.76, 191.36, 189.12, 188.67, 190.83, 188.93,
    189.81, 190.41, 189.63, 189.13, 190.72, 189.87, 188.76, 189.39,
    187.57, 186.59, 182.72, 178.02, 172.85, 166.71, 157.70, 152.17,
    142.09, 134.74, 126.69, 118.63, 114.16, 112.94, 109.92, 108.86,
    108.74, 111.65, 112.90, 115.01, 119.19, 123.18, 131.02, 139.46,
    148.42, 157.34, 164.70, 171.65, 178.33, 182.32, 186.78
]),
            "Ps": np.array([
    -8.66, 12.15, 12.51, 11.07, 8.20, -2.45, 3.21,
    -6.79, -8.99, -10.27, -9.54, 11.91
]),
            "rho": 1.191
        },
        "post": {
            "Pt": np.array([
    187.84, 186.89, 189.51, 190.31, 188.03, 188.17, 189.76, 187.71,
    187.32, 184.71, 177.14, 171.85, 165.80, 158.67, 150.47, 142.84,
    136.15, 129.52, 123.68, 117.71, 113.26, 110.86, 108.28, 109.97,
    108.41, 112.54, 115.21, 116.57, 119.71, 126.17, 128.93, 133.18,
    139.21, 145.17, 148.19, 152.55, 157.88, 161.87, 170.06, 175.43,
    179.77, 182.37, 184.41, 186.24, 187.32, 187.76, 188.63
]),
            "Ps": np.array([
    -4.20, 10.95, 7.97, 1.67, -3.83, -9.06,
    -8.02, -10.20, -9.59, -9.54, -7.06, 11.72
]),
            "rho": 1.191
        }
    },
    15.0: {
        "single": {
            "Pt": np.array([
    186.05, 184.94, 187.59, 188.42, 186.22, 186.20, 187.92, 185.85,
    186.62, 186.96, 184.70, 182.57, 181.60, 177.74, 172.21, 167.57,
    161.70, 154.96, 146.47, 138.27, 130.46, 123.00, 115.56, 111.67,
    105.49, 104.83, 103.13, 100.61, 101.15, 105.09, 105.94, 108.63,
    112.60, 118.53, 122.37, 126.55, 131.81, 136.52, 146.88, 155.09,
    163.29, 170.06, 175.63, 179.48, 182.89, 184.39, 186.79
]),
            "Ps": np.array([
    -9.94, 11.79, 11.27, 7.72, 2.14, -9.94,
    -5.13, -11.88, -11.61, -12.27, -10.75, 11.63
]),
            "rho": 1.191
        }
    },
    16.5: {
        "single": {
            "Pt": np.array([
    190.04, 189.17, 191.77, 192.34, 190.13, 189.57, 191.10, 188.18,
    185.50, 179.90, 168.67, 161.24, 152.45, 142.72, 132.80, 124.52,
    116.29, 109.79, 102.82, 96.73, 92.94, 92.64, 91.62, 94.93,
    95.10, 101.65, 104.96, 106.93, 111.97, 120.92, 124.62, 130.03,
    130.82, 137.95, 142.21, 147.41, 153.77, 157.94, 168.05, 175.71,
    181.93, 185.21, 187.44, 189.10, 190.56, 190.69, 191.38
]),
            "Ps": np.array([
    -12.40, 8.86, 4.88, -3.30, -11.05, -15.66,
    -15.56, -15.78, -16.14, -17.45, -15.93, 9.65
]),
            "rho": 1.191
        }
    }
}

# =============================
# COMPUTE & PLOT
# =============================

plt.rcParams.update({
    "font.size": 11,
    "axes.labelsize": 12,
    "axes.titlesize": 13,
    "legend.fontsize": 10,
    "axes.grid": True,
    "grid.alpha": 0.3
})

# =============================
# COMPUTE & PLOT
# =============================
for aoa, cases in wake_data.items():
    print(f"Plotting wake rake at α = {aoa}°")

    fig, ax = plt.subplots(figsize=(6.5, 7))

    for state, data in cases.items():
        Pt = np.asarray(data["Pt"])
        Ps_static = np.asarray(data["Ps"])
        rho = data["rho"]

        if len(Pt) != len(y_total_mm):
            print(f"  ⚠ Pt length mismatch at α = {aoa}° ({state})")

        # Interpolate static pressure
        Ps_interp = interp_with_linear_extrap(
            y_total_mm, y_static_mm, Ps_static
        )

        # Dynamic pressure
        q = np.maximum(Pt - Ps_interp, 0.0)

        # Velocity
        U = np.sqrt(2.0 * q / rho)

        # Line styles
        linestyle = "-" if state in ["single", "pre"] else "--"
        marker = "o"

        ax.plot(
            U, y_total_mm,
            linestyle=linestyle,
            marker=marker,
            markersize=4,
            linewidth=1.6,
            alpha=0.9,
            label=state.capitalize()
        )

    ax.set_xlabel("Velocity [m/s]")
    ax.set_ylabel("y [mm]")
    ax.set_title(f"Wake Rake Velocity Profile (α = {aoa}°)")
    ax.legend(frameon=True)
    ax.set_ylim(y_total_mm.min(), y_total_mm.max())
    ax.margins(x=0.05)

    plt.tight_layout()
    plt.show()
